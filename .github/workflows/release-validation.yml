name: Seat Brain Release validation

#Control para disparar el pipeline
on:
  push:
    branches: [ "main" ]
    tags: [ 'v*' ]  #Se dispara al crear los tags
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest  #Utilizar un servidor Linux en la nube de Github

    steps:
      - name: Checkout del codigo
        uses: actions/checkout@v4  # Accion oficial para descargar el repo

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14.2'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          # Si hubieran tests aqui se instalaria pytest

      - name: Simular validacion de firmware
        run: |
          echo "Iniciando validacion del cerebro del asiento..."
          python src/seat_controller.py
          echo "Validacion completada con Ã©xito."

      - name: Simular Reporte de Release
        if: startsWith(github.ref, 'refs/tags/v') #Solo si es un TAG
        run: |
          echo "Generando manifiesto para el Release: ${{ github.ref_name }}"
          echo '{"version": "${{ github.ref_name }}", "status": "validated"}' > manifest.json

  #Job 2: Desplegar la infraestructura
  deploy-infrastructure:
    needs: build-and-test    #Solo corre si el job 1 fue exitoso
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve

      - name: Run Health Check
        run: python seat_controller.py

      - name: Upload Incident Report to S3
        if: always() # Esto asegura que se corra incluso si falla lo anterior
        run: |
          if [ -f incident_report.json ]; then
            echo "Incident detected. Uploading report to S3..."
            aws s3 cp incident_report.json s3://hella-seat-brains-reports-leonardo-arroyo/incidents/$(date +%Y-%m-%d)/incident_report.json
          else
            echo "No incident detected."
          fi
